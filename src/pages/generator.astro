---
import Layout from "../layouts/Layout.astro";

// Vérifier l'authentification
const authCookie = Astro.cookies.get("pb_auth");
if (!authCookie) {
  return Astro.redirect("/connexion");
}
---

<Layout title="Générateur SVG">
  <div class="flex flex-col lg:flex-row min-h-[calc(100vh-4rem)]">
    <!-- Aperçu SVG -->
    <div class="lg:w-1/2 bg-base-100 flex flex-col">
      <div class="p-4 bg-base-200 border-b border-base-300">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-bold">Aperçu</h2>
          <a href="/galerie" class="btn btn-secondary btn-sm">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
              ></path>
            </svg>
            Galerie
          </a>
        </div>
      </div>

      <div
        id="svg-container"
        class="flex-1 flex items-center justify-center p-8 bg-base-200"
      >
        <div class="card bg-base-100 shadow-xl w-full max-w-md">
          <div class="card-body items-center text-center">
            <svg
              width="64"
              height="64"
              viewBox="0 0 24 24"
              class="text-primary"
            >
              <path
                d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"
                fill="currentColor"></path>
            </svg>
            <h2 class="card-title">Ton SVG ici</h2>
            <p class="text-base-content/70">Décris ce que tu veux créer</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat et génération -->
    <div class="lg:w-1/2 bg-base-300 flex flex-col">
      <div class="bg-primary text-primary-content p-4">
        <div class="flex items-center gap-3">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
            ></path>
          </svg>
          <h2 class="text-xl font-bold">Conversation</h2>
        </div>
      </div>

      <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div class="alert alert-info">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            class="stroke-current shrink-0 w-6 h-6"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
            ></path>
          </svg>
          <span>Décris le SVG que tu veux générer</span>
        </div>
      </div>

      <!-- Contrôles -->
      <div class="p-4 bg-base-100 border-t border-base-300">
        <div class="join w-full">
          <input
            type="text"
            id="user-prompt"
            placeholder="Décris ton SVG..."
            class="input input-bordered input-primary join-item flex-grow"
          />
          <button id="generate-button" class="btn btn-primary join-item">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
            </svg>
            Envoyer
          </button>
        </div>
        <div class="flex flex-col gap-2 mt-3">
          <button
            class="btn btn-secondary btn-outline hidden w-full"
            id="edit-button"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
              ></path>
            </svg>
            Modifier
          </button>
          <button id="save-button" class="btn btn-success hidden w-full">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5 mr-1"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"
              ></path>
            </svg>
            Sauvegarder
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de sauvegarde -->
  <dialog id="saveModal" class="modal">
    <div class="modal-box">
      <h3 class="text-2xl font-bold mb-2">Sauvegarder le SVG</h3>
      <p class="text-base-content/70 mb-6">Confirme la sauvegarde de ton SVG</p>

      <div class="card bg-base-200 mb-6">
        <div class="card-body">
          <h4 class="card-title text-sm opacity-70 mb-2">Aperçu</h4>
          <div
            id="modalSvgPreview"
            class="flex items-center justify-center h-32"
          >
          </div>
        </div>

        <div class="modal-action">
          <button id="confirmSave" class="btn btn-success"
            >Oui, sauvegarder</button
          >
          <button id="cancelSave" class="btn btn-outline">Annuler</button>
        </div>
      </div>

      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </div>

    <div id="toast" class="toast toast-end hidden">
      <div class="alert alert-success">
        <span>SVG sauvegardé avec succès!</span>
      </div>
    </div>
  </dialog>

  <script>
    let promptList = [];
    let currentPrompt = "";
    let currentSvgCode = "";
    let isEditMode = false;

    async function saveToPocketBase(svgCode) {
      try {
        const response = await fetch("/api/saveSVG", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nom_modele: currentPrompt.substring(0, 50),
            code_svg: svgCode,
            couleur_monture: "#000000",
            couleur_branches: "#000000",
          }),
        });

        if (response.ok) {
          showToast("SVG sauvegardé!");
          return true;
        } else {
          console.error("Erreur:", await response.text());
          return false;
        }
      } catch (error) {
        console.error("Erreur sauvegarde:", error);
        return false;
      }
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      const alertDiv = toast.querySelector(".alert span");
      alertDiv.textContent = message;
      toast.classList.remove("hidden");
      setTimeout(() => toast.classList.add("hidden"), 3000);
    }

    function addMessageToChat(content, isUser = true) {
      const chatContainer = document.getElementById("chat-container");
      const messageDiv = document.createElement("div");

      if (isUser) {
        messageDiv.className =
          "bg-primary text-primary-content p-3 rounded-lg max-w-xs ml-auto";
        messageDiv.textContent = content;
      } else {
        messageDiv.className =
          "bg-secondary text-secondary-content p-3 rounded-lg max-w-md";
        messageDiv.innerHTML = `<pre class="whitespace-pre-wrap text-sm font-mono">${content}</pre>`;
      }

      chatContainer.appendChild(messageDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function generateSVG(messages) {
      const res = await fetch("/api/generateSVG", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ messages }),
      });
      const data = await res.json();
      return data.svg;
    }

    async function handleSubmit() {
      const promptElement = document.getElementById("user-prompt");
      const prompt = promptElement.value.trim();

      if (!prompt) return;

      addMessageToChat(prompt, true);
      promptElement.value = "";

      if (!isEditMode) {
        promptList.length = 0;
        promptList.push({ role: "user", content: prompt });
        currentPrompt = prompt;
        isEditMode = true;
      } else {
        promptList.push({ role: "user", content: prompt });
      }

      const chatContainer = document.getElementById("chat-container");
      const loadingDiv = document.createElement("div");
      loadingDiv.className =
        "bg-secondary text-secondary-content p-3 rounded-lg max-w-md";
      loadingDiv.innerHTML = `<span class="loading loading-dots loading-sm"></span> Génération en cours...`;
      loadingDiv.id = "loading-message";
      chatContainer.appendChild(loadingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      const generateButton = document.getElementById("generate-button");
      generateButton.disabled = true;
      generateButton.textContent = "Génération...";

      try {
        const aiResponse = await generateSVG(promptList);
        const loadingMessage = document.getElementById("loading-message");
        if (loadingMessage) loadingMessage.remove();

        const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
        const finalSvgCode = svgMatch ? svgMatch[0] : aiResponse.content;

        if (finalSvgCode && finalSvgCode.trim() !== "") {
          addMessageToChat(finalSvgCode, false);
          document.getElementById("svg-container").innerHTML = finalSvgCode;
          currentSvgCode = finalSvgCode;
          promptList.push({ role: "assistant", content: finalSvgCode });

          document.getElementById("save-button").classList.remove("hidden");
          document.getElementById("edit-button").classList.remove("hidden");
        } else {
          addMessageToChat("Erreur: pas de SVG généré", false);
        }
      } catch (error) {
        console.error("Erreur:", error);
        const loadingMessage = document.getElementById("loading-message");
        if (loadingMessage) loadingMessage.remove();
        addMessageToChat("Erreur lors de la génération", false);
      }

      generateButton.disabled = false;
      generateButton.textContent = "Envoyer";
    }

    async function handleEdit() {
      const promptElement = document.getElementById("user-prompt");
      const prompt = promptElement.value.trim();

      if (!prompt) return;

      addMessageToChat(prompt, true);
      promptElement.value = "";
      promptList.push({ role: "user", content: prompt });

      const chatContainer = document.getElementById("chat-container");
      const loadingDiv = document.createElement("div");
      loadingDiv.className =
        "bg-secondary text-secondary-content p-3 rounded-lg max-w-md";
      loadingDiv.innerHTML = `<span class="loading loading-dots loading-sm"></span> Modification en cours...`;
      loadingDiv.id = "loading-message";
      chatContainer.appendChild(loadingDiv);
      chatContainer.scrollTop = chatContainer.scrollHeight;

      const editButton = document.getElementById("edit-button");
      editButton.disabled = true;

      try {
        const aiResponse = await generateSVG(promptList);
        const loadingMessage = document.getElementById("loading-message");
        if (loadingMessage) loadingMessage.remove();

        const svgMatch = aiResponse.content.match(/<svg[\s\S]*?<\/svg>/i);
        const finalSvgCode = svgMatch ? svgMatch[0] : aiResponse.content;

        if (finalSvgCode && finalSvgCode.trim() !== "") {
          addMessageToChat(finalSvgCode, false);
          document.getElementById("svg-container").innerHTML = finalSvgCode;
          currentSvgCode = finalSvgCode;
          promptList.push({ role: "assistant", content: finalSvgCode });
        } else {
          addMessageToChat("Erreur lors de la modification", false);
        }
      } catch (error) {
        console.error("Erreur:", error);
        addMessageToChat("Erreur lors de la modification", false);
      }

      editButton.disabled = false;
    }

    function showSaveModal() {
      const modal = document.getElementById("saveModal");
      document.getElementById("modalSvgPreview").innerHTML = currentSvgCode;
      modal.showModal();
    }

    async function confirmSave() {
      const modal = document.getElementById("saveModal");
      const success = await saveToPocketBase(currentSvgCode);

      if (success) {
        document.getElementById("save-button").classList.add("hidden");
        document.getElementById("edit-button").classList.add("hidden");

        promptList = [];
        currentPrompt = "";
        currentSvgCode = "";
        isEditMode = false;

        document.getElementById("user-prompt").value = "";
        document.getElementById("chat-container").innerHTML = `
          <div class="alert alert-info">
            <span>Décris le SVG que tu veux générer</span>
          </div>
        `;
        document.getElementById("svg-container").innerHTML = `
          <div class="card bg-base-100 shadow-xl w-full max-w-md">
            <div class="card-body items-center text-center">
              <svg width="64" height="64" viewBox="0 0 24 24" class="text-primary">
                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" fill="currentColor"></path>
              </svg>
              <h2 class="card-title">Ton SVG ici</h2>
              <p class="text-base-content/70">Décris ce que tu veux créer</p>
            </div>
          </div>
        `;
      }

      modal.close();
    }

    function cancelSave() {
      document.getElementById("saveModal").close();
    }

    document
      .getElementById("generate-button")
      .addEventListener("click", handleSubmit);
    document
      .getElementById("edit-button")
      .addEventListener("click", handleEdit);
    document
      .getElementById("save-button")
      .addEventListener("click", showSaveModal);
    document
      .getElementById("confirmSave")
      .addEventListener("click", confirmSave);
    document.getElementById("cancelSave").addEventListener("click", cancelSave);

    document.getElementById("user-prompt").addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        isEditMode ? handleEdit() : handleSubmit();
      }
    });
  </script>
</Layout>
