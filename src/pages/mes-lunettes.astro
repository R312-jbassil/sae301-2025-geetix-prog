---
import Layout from "../layouts/Layout.astro";
import PocketBase from "pocketbase";

const authCookie = Astro.cookies.get("pb_auth");
if (!authCookie) {
  return Astro.redirect("/connexion");
}

const pb = new PocketBase("http://127.0.0.1:8090");
const authData = JSON.parse(decodeURIComponent(authCookie.value));
pb.authStore.save(authData.token, authData.model);

const userId = pb.authStore.model.id;
const lunettes = await pb.collection("Lunettes").getFullList({
  filter: `user.id = "${userId}"`,
  sort: "-created",
});
---

<Layout title="Galerie - TaVue">
  <div class="min-h-screen bg-base-200 px-4 py-12">
    <div class="max-w-6xl mx-auto">
      <h1 class="text-4xl font-bold text-center mb-12">Ma Galerie</h1>

      {
        lunettes.length === 0 ? (
          <div class="text-center">
            <p class="text-xl mb-6">Pas encore de lunettes</p>
            <a href="/configurateur" class="btn btn-primary">
              Créer une paire
            </a>
          </div>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {lunettes.map((lunette) => (
              <div class="card bg-white shadow">
                <div class="card-body">
                  <h3 class="card-title text-lg">{lunette.nom_modele}</h3>
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 595.28 841.89"
                    class="h-32 w-full"
                    set:html={lunette.code_svg}
                  />
                  <p class="text-sm text-gray-600">
                    {new Date(lunette.created).toLocaleDateString()}
                  </p>
                  <button
                    class="btn btn-sm btn-error mt-4 delete-btn"
                    data-id={lunette.id}
                  >
                    Supprimer
                  </button>
                </div>
              </div>
            ))}
          </div>
        )
      }
    </div>
  </div>
</Layout>

<script>
  document.querySelectorAll(".delete-btn").forEach((btn) => {
    btn.addEventListener("click", async (e) => {
      if (!confirm("Sûr ?")) return;
      const id = (e.target as HTMLButtonElement).dataset.id;
      await fetch(`/api/lunettes/${id}/delete`, { method: "DELETE" });
      window.location.reload();
    });
  });
</script>
